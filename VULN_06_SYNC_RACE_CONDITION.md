# –í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å: Race Condition —É SyncService (Lost Update) (VULN_06)

## üìù –û–ø–∏—Å
–£ —Ñ–∞–π–ª—ñ `src/lib/firebase/SyncService.svelte.ts` –º–µ—Ç–æ–¥ `handleCloudUpdate` –±–ª–æ–∫—É—î –æ–±—Ä–æ–±–∫—É –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ —Ö–º–∞—Ä–∏, —è–∫—â–æ –≤ —Ü–µ–π –º–æ–º–µ–Ω—Ç —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ü–µ—Å –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (`isUploading`).

```typescript
private handleCloudUpdate(cloudData: any) {
    if (this.isUploading || !auth.currentUser) return;
    this.isDownloading = true;
    // ...
}
```

## üî¥ –†–∏–∑–∏–∫–∏
1. **–í—Ç—Ä–∞—Ç–∞ –¥–∞–Ω–∏—Ö (Lost Update):** –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω–∏–≤ –¥–∞–Ω—ñ –Ω–∞ –æ–¥–Ω–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó —Ç–∞ –ø–æ—á–∞–≤ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é, –∞ –≤ —Ü–µ–π –∂–µ –º–æ–º–µ–Ω—Ç –ø—Ä–∏–π—à–ª–∏ –∑–º—ñ–Ω–∏ –∑ —ñ–Ω—à–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é, –≤–æ–Ω–∏ –±—É–¥—É—Ç—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—ñ–≥–Ω–æ—Ä–æ–≤–∞–Ω—ñ. 
2. **–î–µ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è:** –õ–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–æ—Ä –∑–∞–ª–∏—à–∏—Ç—å—Å—è –∑—ñ —Å—Ç–∞—Ä–∏–º–∏ –¥–∞–Ω–∏–º–∏, –∞–ª–µ `updatedAt` –º–æ–∂–µ –±—É—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–¥ —á–∞—Å –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —â–æ –∑—Ä–æ–±–∏—Ç—å —Ö–º–∞—Ä–Ω—ñ –¥–∞–Ω—ñ "—Å—Ç–∞—Ä—ñ—à–∏–º–∏" –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É.

## üõ† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
1. **Queuing:** –ó–∞–º—ñ—Å—Ç—å –Ω–µ–≥–∞–π–Ω–æ–≥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (`return`), —Å—Ç–∞–≤–∏—Ç–∏ –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –≤ —á–µ—Ä–≥—É –Ω–∞ –æ–±—Ä–æ–±–∫—É –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è `isUploading`.
2. **Version Matching:** –ü–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ `updatedAt` –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º –∑–∞–ø–∏—Å–æ–º —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó Firestore –¥–ª—è –≥–∞—Ä–∞–Ω—Ç—É–≤–∞–Ω–Ω—è, —â–æ –º–∏ –Ω–µ –∑–∞—Ç–∏—Ä–∞—î–º–æ –Ω–æ–≤—ñ—à—ñ –¥–∞–Ω—ñ.

---

## ‚úÖ –°—Ç–∞—Ç—É—Å: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ (05.02.2026)
–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ –º–µ—Ö–∞–Ω—ñ–∑–º `pendingCloudUpdate`. –¢–µ–ø–µ—Ä, —è–∫—â–æ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö (`isUploading`) –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ —Ö–º–∞—Ä–∏ —á–µ—Ä–µ–∑ `onSnapshot`, –≤–æ–Ω–æ –Ω–µ —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è, –∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ —Ç–∏–º—á–∞—Å–æ–≤—É –∑–º—ñ–Ω–Ω—É. –û–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∞–±–æ –Ω–µ—É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è `performUpload`, —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫–ª–∞–¥–µ–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ. –¶–µ –ø–æ–≤–Ω—ñ—Å—Ç—é —É—Å—É–≤–∞—î Race Condition "–≤—Ç—Ä–∞—á–µ–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è" –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –¥–µ–∫—ñ–ª—å–∫–æ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤.

