---
title: План Покращення Архітектури v00
description: Базовий аудит та план переходу до AI-Friendly архітектури (Svelte 5 + Runes)
type: plan
status: 100%
created: 2026-02-04
---

# Архітектурний Аудит та План Оптимізації

Цей документ фіксує поточний стан архітектури проєкту Slovko та визначає дорожню карту для підвищення якості коду, стабільності та зручності підтримки (особливо для AI-агентів).

## Частина 1: Комплексний Аудит

### 1. Reactivity & State (Реактивність) — 65/100

**Статус:** Перехідний етап. Використовуються Svelte 5 Runes (`$state`, `$derived`), але логіка оновлення часто залишається імперативною.

- **Derived over Sync:** ⚠️ **Проблема.** У `SyncService` та `playlistStore` ми спостерігаємо ручне оновлення стану (`_internalSet`), замість того щоб стан автоматично виводився з джерела істини. Нещодавній баг з `systemPlaylists` виник саме через ручне керування структурою даних.
- **Effect Discipline:** ✅ **Добре.** Надмірного використання `$effect` для бізнес-логіки не помічено, але треба стежити за `logService`.
- **Fine-grained Reactivity:** ⚠️ **Проблема.** `SyncService` часто перезаписує великі об'єкти цілком (`state = newData`), що вбиває переваги точкової реактивності Runes.

### 2. Architecture & Data (Архітектура) — 50/100

**Статус:** Client-side Heavy (SPA/PWA) на базі SvelteKit.

- **Server-First:** ❌ **Відхилення.** Проєкт працює як SPA (`ssr = false` у `+page.ts`). Це виправдано для PWA/Game, але втрачає переваги серверної валідації SvelteKit.
- **URL as State:** ⚠️ **Частково.** Є `UrlParamsSchema` у `+page.ts`, але синхронізація з `settingsStore` працює в один бік (URL -> Store). Немає гарантії двонаправленого зв'язку.
- **Type Safety:** ⚠️ **Критично.** Використання `zod` є, але в критичних місцях (`SyncService.ts`, `playlistStore.svelte.ts`) забагато `any` або нестрогих типів. Це призвело до того, що "биті" дані з Firebase зламали клієнт.

### 3. Component Design (Дизайн компонентів) — 60/100

**Статус:** Монолітна логіка.

- **Headless Logic:** ⚠️ **Проблема.** Логіка гри та налаштувань часто переплетена з UI. `+page.ts` виконує роль контролера, який знає занадто багато про структуру сторів.
- **Locality of Behavior:** ✅ **Добре.** Структура папок згрупована логічно.
- **Composition:** ⚪ **Нейтрально.** Потребує детальнішого аналізу UI компонентів.

### 4. Stability & Performance (Стабільність) — 45/100

**Статус:** Вразливість до Race Conditions.

- **Error Boundaries:** ❌ **Відсутні.** Глобальні `try-catch` у `load` функціях повертають об'єкти помилок, замість використання механізму `<svelte:boundary>` або `+error.svelte`. Це змушує писати захисний код (`?.`) у кожному компоненті.
- **Cleanup:** ⚠️ **Ризик.** `SyncService` має ручні підписки та таймаути. Потрібен ретельний перегляд `onDestroy` логіки.
- **Data Integrity:** ❌ **Критично.** Недавній фікс показав, що додаток довіряв даним з `localStorage` та Firebase без валідації схеми.

### 5. Security & A11y (Безпека та Доступність) — 75/100

**Статус:** Задовільно.

- **Input Validation:** ✅ **Добре.** Використання Zod для параметрів.
- **Role Management:** ⚪ **Нейтрально.** Firebase rules потребують окремого аудиту.

---

## Частина 2: План Покращень (Backlog)

### Пріоритет: Data Integrity & Stability (AI-Friendly Foundation)

Ці зміни критичні для того, щоб AI міг безпечно вносити зміни, не ламаючи логіку синхронізації.

- [x] **1. Впровадження Zod-схем для всього State (Schema-First State).** [Impact: 100]
  - _Problem:_ `playlistStore` та `progressStore` приймають `any` або часткові об'єкти під час гідратації/синхронізації.
  - _Solution:_ Описати повні Zod-схеми для `PlaylistState`, `ProgressState`. Використовувати `Schema.parse()` при завантаженні з `localStorage` та Firebase. Якщо дані биті — робити міграцію або фолбек на рівні парсера, а не в UI.
  - _Status:_ Впроваджено для всіх основних сторів (Settings, Progress, Playlists).

- [x] **2. Рефакторинг `SyncService` (Architecture).** [Impact: 95]
  - _Problem:_ Величезний об'єкт з ручним керуванням таймерами та мутаціями. Важко тестувати та дебажити.
  - _Solution:_ Розбити на менші класи/функції. Використати паттерн "State Machine" для станів (Offline, Syncing, Error, Up-to-date). Прибрати ручний `mergeData` на користь типізованого deep-merge з валідацією.
  - _Status:_ Переведено на OOP (SyncServiceClass), впроваджено реактивний статус синхронізації та сувору валідацію через Zod.

- [x] **3. Strict Type Guards у Stores.** [Impact: 90]
  - _Problem:_ Методи типу `_internalSet` дозволяють записати будь-що.
  - _Solution:_ Прибрати `any`. Всі методи стору повинні приймати лише валідовані типи.
  - _Status:_ Видалено `any` з критичних шляхів синхронізації, стори використовують типізовані схеми.

### Пріоритет: Code Organization (Simplification)

- [x] **4. Винесення логіки з `+page.ts` у Domain Services.** [Impact: 80]
  - _Problem:_ `load` функція займається бізнес-логікою (порівняння налаштувань, мапінг плейлістів).
  - _Solution:_ Створити `GameOrchestrator` або розширити `GameDataService`, який повертатиме готовий, гарантовано валідний об'єкт `GameSession`. `+page.ts` має лише викликати цей сервіс.
  - _Status:_ Створено `GameOrchestrator`, логіку мапінгу плейлістів перенесено в `playlistStore.getSnapshot()`. `+page.ts` став максимально тонким.

- [x] **5. Перехід на `<svelte:boundary>`.** [Impact: 75]
  - _Problem:_ "Білий екран" або консольні помилки при збоях у віджетах.
  - _Solution:_ Огорнути критичні блоки (Гру, Список плейлістів) у Boundaries. Це дозволить показувати локальні помилки ("Не вдалося завантажити плейліст") замість падіння сторінки.
  - _Status:_ Впроваджено `<svelte:boundary>` у компонент `ErrorBoundary`. Огорнуто основні вузли додатку.

### Пріоритет: Developer Experience & Clean Code

- [ ] **6. Стандартизація Alias Imports.** [Impact: 40]
  - _Solution:_ Перевірити, чи всюди використовуються `$lib/`, `$components/` замість `../../`. Це спрощує навігацію для AI.

- [ ] **7. Документування критичних потоків даних.** [Impact: 60]
  - _Solution:_ Створити `docs/DATA_FLOW.md`, де описати, як дані подорожують від Firebase -> SyncService -> Store -> UI.

### Таблиця Прогресу

| Задача                       | Пріоритет (0-100) | Статус | Коментар                                          |
| :--------------------------- | :---------------: | :----: | :------------------------------------------------ |
| **Schema-First State (Zod)** |      **100**      |   ✅   | Впроваджено для всіх основних сторів              |
| **Refactor SyncService**     |      **95**       |   ✅   | Переведено на OOP + Reactive Status               |
| **Strict Typing (No Any)**   |      **90**       |   ✅   | Видалено 'any' з критичних шляхів синхронізації   |
| **Logic out of +page.ts**    |      **80**       |   ✅   | Впроваджено GameOrchestrator та Store Snapshots   |
| **Error Boundaries**         |      **75**       |   ✅   | Ізольовано основні вузли додатку                  |

### Обов'язкова Верифікація

Кожен пункт плану (задача) повинен завершуватися обов'язковим виконанням наступних команд:
- `npm run check` (усі помилки ТА попередження мають бути виправлені).
- `npm audit` (вразливості мають бути відсутні).