---
title: План Реалізації: Взаємодія Гравців (Presence & Interactions)
description: Впровадження статусу онлайн та механіки "махання рукою" через Realtime Database
type: plan
status: 0%
created: 2026-02-05
---

# План Реалізації: Взаємодія Гравців

Цей документ описує архітектуру та етапи впровадження системи реального часу для відстеження статусу гравців та обміну миттєвими сигналами ("Wave").

## 1. Архітектура

Для реалізації "живої" взаємодії ми використаємо **Firebase Realtime Database (RTDB)** замість Firestore. RTDB ідеально підходить для механізму присутності (Presence), оскільки підтримує події `onDisconnect`, що дозволяє надійно фіксувати вихід користувача з мережі навіть при закритті вкладки.

### Структура даних RTDB

```json
{
  "status": {
    "{userId}": {
      "state": "online" | "offline",
      "lastChanged": 1700000000000,
      "currentLevel": "A1" // Опціонально: де зараз гравець
    }
  },
  "signals": {
    "{targetUserId}": {
      "{signalId}": {
        "type": "wave" | "wave_back",
        "fromUid": "sender_uid_123",
        "fromName": "User Name",
        "fromPhoto": "url_or_internal_icon",
        "timestamp": 1700000000000
      }
    }
  }
}
```

### Правила Безпеки (Realtime Database Rules)

Ці правила потрібно зберегти у файл `database.rules.json` і застосувати в консолі Firebase.

```json
{
  "rules": {
    "status": {
      "$uid": {
        // Кожен може читати статус інших
        ".read": "auth != null",
        // Тільки власник акаунта може змінювати свій статус
        ".write": "$uid === auth.uid",
        // Валідація даних
        ".validate": "newData.hasChildren(['state', 'lastChanged']) && (newData.child('state').val() === 'online' || newData.child('state').val() === 'offline')"
      }
    },
    "signals": {
      "$uid": {
        // Користувач може читати свої сигнали
        ".read": "$uid === auth.uid",
        // Інші можуть писати (надсилати) сигнали цьому користувачу
        "$signalId": {
          ".write": "auth != null && newData.child('fromUid').val() === auth.uid"
        }
      }
    }
  }
}
```

## 2. Нові Сервіси та Компоненти

### 2.1. `PresenceService.ts`
Відповідає за:
- Підключення до RTDB.
- Керування власним статусом (`onDisconnect().set('offline')`).
- Підписку на статус друзів (тільки тих, хто у списку `following`).
- Надсилання та отримання сигналів ("махання").

### 2.2. `UserAvatar.svelte` (Оновлення)
- Додати індикатор статусу (зелений кружечок).
- Логіка: якщо `PresenceService` повідомляє, що `uid` онлайн -> показати індикатор.

### 2.3. `InteractionBubble.svelte` (Новий)
- Плаваючий елемент (зліва зверху).
- Відображає аватарку + анімацію (поява / рука).
- Зникає через 5 секунд.
- При кліку відкриває `InteractionMenu`.

### 2.4. `InteractionMenu.svelte` (Новий)
- Спливаюче меню при кліку на аватар.
- Показує нікнейм.
- Кнопка "Помахати" (іконка `Hand` з lucide-svelte).

## 3. План Впровадження (Backlog)

### Етап 1: Налаштування та Presence
- [ ] **1. Ініціалізація RTDB.**
    - Оновити `src/lib/firebase/config.ts` (додати `getDatabase`).
    - Створити файл `database.rules.json`.
- [ ] **2. Створення `PresenceService`.**
    - Реалізувати логіку `goOnline` / `goOffline`.
    - Реалізувати відстеження статусу друзів.
- [ ] **3. Оновлення `UserAvatar`.**
    - Інтегрувати індикатор онлайн-статусу.

### Етап 2: Сигнали та Сповіщення
- [ ] **4. Реалізація механізму сигналів.**
    - Метод `sendWave(targetUid)`.
    - Слухач вхідних сигналів.
- [ ] **5. Створення `InteractionBubble`.**
    - Компонент для відображення подій ("Друг зайшов", "Хтось махає").
    - Анімація появи/зникнення.

### Етап 3: Інтерактивність
- [ ] **6. Створення `InteractionMenu`.**
    - Логіка кліку на аватар.
    - Кнопка "Помахати".
- [ ] **7. Інтеграція в гру.**
    - Підключити `InteractionBubble` в `+layout.svelte` або `+page.svelte`.
    - Забезпечити, щоб меню відкривалося з будь-якого місця (Avatar click).

### Обов'язкова Верифікація
Кожен етап завершувати `npm run check` та оновленням статусу в цьому файлі.
